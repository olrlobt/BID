
## 사용 기술

### 1. 블렌더


![웹소켓](/docs/웹소켓.gif)

 프로젝트 B:D는 학생과 선생님, 두 가지 유저 유형을 대상으로 하는 서비스로, 특히 초등학생을 대상으로 하는 학생 페이지에서는 게이미피케이션 기법을 적극 활용하고 있습니다. 이 서비스는 경제 교육을 더 쉽고 재미있게 제공하기 위해 시각적 모델을 사용하여 은행이나 경매장과 같은 장소를 빌딩처럼 표현합니다.

 학생들은 이러한 빌딩을 클릭하여 들어갈 수 있으며, 메타버스 게임 형식으로 구성되어 있어 학생들이 자신의 아바타를 통해 서비스에 더 쉽게 몰입할 수 있도록 설계되었습니다.

 이 시각적 모델들은 3D 모델링 툴인 블렌더를 사용하여 직접 제작되었습니다. 제작된 모델들은 React Three Fiber를 사용하여 웹페이지에 통합되며, 이 과정에서 모델들은 GLTF 형식으로 변환되어 웹상에서 표현됩니다. 이러한 접근 방식은 학생들에게 경제 개념을 더 친숙하고 상호작용적인 방법으로 가르치는 데 도움을 줍니다.

### 2. 웹소켓

B:D의 메인 페이지는 학생들이 각자의 캐릭터를 가지고 있는 모델링된 학급 UI와 아바타를 표시하며, 이로 인해 자연스럽게 채팅 기능과 캐릭터 움직임 구현의 필요성이 대두되었습니다. 

이에 따라, 프론트엔드에서 독립적으로 소켓을 구현하여 실시간 통신을 가능하게 했습니다. 

이는 데이터 교환보다는 학생들이 메인 페이지에 접속했을 때 실시간으로 친구들과 양방향 소통을 할 수 있도록 하는 기능에 중점을 두었고, 이를 통해 학생들이 경제 금융 플랫폼에 대한 부담감을 줄이고, 친구들과의 소통을 통해 플랫폼에 머무르는 시간을 늘리고자 했습니다.

구체적으로는, 리액트 프로젝트와 함께 소켓 서버를 프론트엔드 폴더 내에 위치시키고, `Server`의 `index.js`에서 소켓을 관리했습니다. 이 웹소켓을 통해 학생들은 실시간으로 아바타를 클릭하고 드래그하여 교실 내에서 움직이게 할 수 있으며, 서로 메시지를 주고받으며 소통할 수 있습니다. 이러한 기능은 메타버스 환경을 구축하는 데 핵심적인 역할을 하며, 데이터 저장이 필요 없는 이 상호작용은 프론트엔드에서만 웹소켓을 활용하여 구현되었습니다.

### 3. 스프링 배치

B:D 서비스는 클라이언트의 직접적인 요청에 대한 기능들도 제공하지만 분석 및 통계 처리를 통해 세율, 소득/지출에 대한 대시보드, 권장주급, 적금 등 다양한 `자동화된 대용량 작업`들이 동작하는 서비스입니다.

이러한 로깅/추적, 작업 처리 통계와 같은 대용량 레코드 처리는 단순히 반복문을 통해 구현하기 보단 대용량 및 고성능 배치 작업을 가능하게 하는 기술을 도입하여 처리하는 것이 서비스의 품질 및 성능 향상에 도움이 될 것이라 판단하였습니다.

이에 대용량 레코드 처리를 위한 방식으로 `Spring Batch` 라이브러리를 도입하였습니다.

Spring Batch는 최적화 및 파티셔닝 기술을 통해 대용량 및 고성능 배치 작업을 가능하게 합니다.

뿐만 아니라 배치 작업이 실패하여 작업을 재시작하게 된다면 처음부터가 아닌 실패한 지점부터 실행을 시킴으로써 효율성을 향상시킵니다.

또한 Paging Size(한번에 쌓이는 트랜잭션)와 Chunk Size(한번에 처리될 트랜잭션) 크기를 동일하게 맞추어 주어 대용량의 트랜잭션 처리에 대한 성능 향상을 달성합니다.

작업을 실행시키기 위해 Spring Framework에서 제공하는 Scheduler를 활용하여 지정된 시간에 알맞은 배치 작업이 이루어지도록 구성하였습니다.

배치 작업 내역은 다음과 같습니다.

1. 실시간 알림 :
    - 실시간 알림이 자동으로 설정되어 주기적으로 전송되어야 할 때 지정된 배치 작업이 수행되어 필터링된 학생들에게 알림이 전송됩니다.
2. 출결 및 주급 지급 :
    - 데이터베이스에 저장되는 학생들의 출결 상태는 금주 5일뿐이며, 이는 일요일 자정에 서비스에 가입된 모든 학생사용자의 출결상태가 초기화됩니다.
    - 출결상태가 초기화 되기 이전 세금 및 출결 일수에 따라 작성된 B:D의 주급계산 알고리즘에 따른 결과값이 매주 모든 학생 사용자에게 지급됩니다.
3. 적금 만기 및 이체 :
    - 학생이 가입한 적금 상품의 만기일에 다다른 경우, 적금의 만기금액을 학생 사용자에게 지급합니다.
    - 이체의 경우 정해진 이체 일시에 다다른 경우, 학생 사용자로부터 적금 금액을 송금 받습니다.
    - 적금 갱신은 1일을 기준으로 하기 때문에 해당 배치 작업은 모든 적금에 가입된 학생들을 대상으로 각각 매일 적금 금액을 이체하기 이전인 오전 8:40와 오후 03:00에 수행됩니다.
4. 권장 주급 계산 :
    
    ```
    B:D 서비스는 매주 일정하게 지급되는 화폐가 존재하기 때문에 
    인플레이션 및 디플레이션 위험으로부터 안전하기 위한 두가지 방안을 구현해두었습니다.
    
    그 중 "권장 주급"이란, 해당 학급의 학생들의 지난 2주간의 거래량 및 총거래금액을 바탕으로, 그 양에 반비례하여 권장 주급을 설정하고 있습니다.
    상세히는 거래량 및 거래금액이 20%가 오를 때마다 권장 주급은 10%씩 낮추고, 반대로 내릴때마다 10%씩 올립니다.
    
    만약 거래량 및 거래금액이 80%를 초과하여 오르거나 내린다면 각각 인플레이션과 디플레이션 위험군으로 판단하였습니다.
    ```
    
    - 매주 일요일 오후 10시 50분에 권장 주급 계산 알고리즘이 적용된 권장주급 데이터가 데이터베이스의 학급 테이블에 갱신됩니다.
    - 이는 서비스에 저장된 모든 학급에 대해 적용되는 배치 작업 입니다.
5. 세금 계산 :
    
    ```
    위의 방안 중 두번째 방안은 "세금 적용"입니다.
    
    B:D 서비스에는 학급의 무분별한 화폐 생산으로 인한 부작용을 방지하고,
    학생들이 미리 실물 경제를 경험할 수 있도록 소득세와 부가가치세(VAT)를 적용하고 있습니다.
    
    소득세율은 실제 대한민국의 소득분위에 따른 세율(한국은행 자료)을 참고하여 
    0. 주급도 온전히 받지 못하는 경우.
    1. 주급(모두에게 주어지는 기본급여)을 모두 받는 경우.
    2. 주급 + 일주일에 1~2회 경제 활동 참여하는 경우.
    3. 주급 + 일주일에 3~4회 경제 활동 참여하는 경우.
    4. 주급 + 매일 적어도 1회 경제 활동에 참여하는 경우.
    5. 주급 + 매일 2~3회 경제 활동에 참여하는 경우.
    위와 같이 6분위로 소득분위를 구분하고, 3%에서부터 각각 2%씩 차이가 나도록 세율을 설정해주었습니다.
    이때, 최대 세율(15%)와 최소세율(3%)의 차이는 12%입니다.
    
    부가가치세는 모든 소비활동에 고정된 7%를 포함시키도록 하였습니다.
    ```
    
    - 매주 일요일 오후 11시 50분에 세금 계산 알고리즘이 적용되어 데이터베이스에 저장된 모든 학생들에 알맞은 소득분위를 적용합니다.
6. 통계 관리 :
    - 통계데이터는 B:D 서비스에서 활동한 학생들의 모든 내역을 반영하여 대시보드 형태로 학생들이 확인할 수 있도록 합니다.
    - 이때, 통계 데이터는 데이터베이스의 계좌내역, 입찰내역, 적금내역, 주급내역, 리워드내역 총 5개의 테이블을 고려하여 계산해야하는 큰 단위의 연산입니다.
    - 뿐만 아니라 그 대상이 되는 것은 데이터베이스에 저장된 모든 학생들이기 때문에 배치 작업으로 분류하여 효율적인 대용량 연산이 필요함을 판단하였습니다.
    - 작업은 1일을 기준으로 갱신되어야 하기  때문에 매일 오전 4시에 실행되도록 하였습니다.
    - 통계 데이터에 즉시 조회를 사용하지 않아도된다고 생각한 이유는 서비스의 규모가 커지고 데이터베이스에 데이터가 쌓이게된다면, 그 통계값 역시 단위가 커지는 통계적 특성에 의해 어느정도의 오차범위를 허용하기 때문입니다.
    - 이에 정확한 값보다 자주 호출되는 API의 성능을 향상시키는 것이 우선이라 판단하였습니다.
7. 경매 종료 :
    - 등록된 경매 게시물의 종료교시가 되면 자동으로 해당하는 모든 경매 게시물을 종료시키고, 입찰자 및 낙찰자에 따라 사후처리를 진행합니다.
    - 입찰자들로부터 입찰받은 금액은 모두 되돌려주며, 낙찰자에게는 낙찰 확인 버튼이 달린 실시간 알림을 전송합니다.
8. 경매 홀드 :
    - 학생들이 수업시간에 무분별하게 경매에 참여하여 집중력을 흐리는 것을 방지하기 위해 데이터베이스에 등록된 수업시간 동안에 모든 진행중인 경매를 잠시 중단시키는 기능입니다.
    - 해당 기능은 데이터베이스에 저장된 모든 학급에 대해 수업시간과 진행 중인 경매게시물 데이터에 대한 대용량 배치 작업입니다.

### 4. Server Sent Event(SSE)

B:D 서비스에 클라이언트의 요청이 없어도 서버에서 데이터를 전달해줘야 하는 `실시간 알림` 요구사항이 존재합니다.

이는 Client의 요청이 있어야만, Server가 응답하도록 정해진 전통적인 Client-Server 모델의 HTTP 통신에서는 이런 기능을 구현할 수 없습니다.

이에 Client의 요청이 없어도 Server의 변경사항을 알아서 지정된 Client로 응답하도록 하는 방식으로 `Server Sent Event(SSE)` 를 사용하였습니다.

SSE는 Server에서 Client로 텍스트 메시지를 전송하는 브라우저 기반 웹 애플리케이션 기술입니다.

Spring Framework를 사용함에 따라 코드 구현은 프레임에서 제공하는 SSE 통신을 지원하는 SseEmitter API를 사용하였습니다.

SSE를 통해 구현한 실시간 알림 플로우는 다음과 같습니다.

1. 알림의 수신자는 알림의 수신자 모듈 서버에 구독 요청을 보냅니다.
2. 구독 요청이 정상적으로 이루어진 경우, 송신자의 서버에는 수신자의 PK를 key, 수신자에게 할당된 SseEmitter을 value로 저장해둡니다.
    - 또한 연결이 지속되는 동안에 이벤트는 캐싱하지 않으며 지속적 연결을 사용합니다.
3. 이후 해당 수신자에게 Server는 비동기적으로 데이터를 전송할 수 있습니다.
4. 전송된 실시간 알림 내역은 B:D 데이터베이스의 Notification 테이블에 저장되어 이후 알림 내역을 14일간 유지할 수 있도록 합니다.

[실시간 알림내역]

1. 리워드 전송 : 
    - 관리자로부터 받은 리워드 내역을 실시간 알림으로 보여줍니다.

1. 적금 이체 알림 : 
    - 적금 이체 당일 오전 08:50에 적금 이체 실시간 알림을 보내줍니다.

1. 적금 만기 알림 : 
    - 적금이 만료되었을 경우, 이를 실시간 알림으로 알려줍니다.

1. 경매 낙찰 알림 : 
    - 자신이 낙찰된 경매 내역 및 낙찰가에 가장 가까웠던 상위 5명의 입찰가를 실시간 알림으로 보여줍니다.
    - 이때, 함께 뜨는 확인 버튼을 누르면, 낙찰가가 자동 송금되고 낙찰이 확정됩니다.

1. 경매 유찰 알림 : 
    - 자신이 유찰된 경매 내역 및 낙찰가와 낙찰가에 가장 가까웠던 상위 5명의 입찰가를 실시간 알림으로 보여줍니다.

1. 경매 낙찰 확정(송금) 알림 : 
    - 낙찰자가 확인 버튼을 통해 자신의 낙찰을 확정하고, 낙찰가를 송금하면 이를 실시간 알림으로 알려줍니다.
